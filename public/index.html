<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Coach AI - Dashboard</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Heebo:wght@300;400;500;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: '#09090b',
                        surface: '#18181b',
                        surfaceHighlight: '#27272a',
                        primary: '#3b82f6',
                        primaryGlow: 'rgba(59, 130, 246, 0.5)',
                        accent: '#8b5cf6',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        textMain: '#fafafa',
                        textMuted: '#a1a1aa'
                    },
                    fontFamily: {
                        sans: ['Heebo', 'Outfit', 'sans-serif'],
                    }
                }
            }
    </script>
    <style>
        body {
            background-color: #09090b;
            color: #fafafa;
            height: 100vh;
            overflow: hidden;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #27272a;
            border-radius: 3px;
        }

        .glass-panel {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* SCROLLABLE TRANSCRIPT AREA - REFACTORED */
        #transcript-panel {
            display: flex;
            flex-direction: column;
            flex: 1;
            /* Occupy remaining space */
            min-height: 0;
            /* Critical for flex scrolling */
            width: 100%;
            position: relative;
        }

        #transcript-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px 80px;
            /* Extra padding at bottom for input area */
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: smooth;
        }

        .transcript-message {
            display: flex;
            flex-direction: column;
            max-width: 80%;
            position: relative;
            transition: all 0.2s ease-out;
            flex-shrink: 0;
            /* Prevent shrinking */
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .transcript-message.new {
            animation: fadeIn 0.3s forwards;
        }

        .transcript-message.agent {
            align-self: flex-start;
        }

        /* Agent (Right in RTL) -> Flex Start */
        .transcript-message.customer {
            align-self: flex-end;
        }

        /* Customer (Left in RTL) -> Flex End */

        .transcript-label {
            font-size: 0.7rem;
            /* text-xs */
            font-weight: 700;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .transcript-message.agent .transcript-label {
            color: #a1a1aa;
            /* textMuted */
        }

        .transcript-message.customer .transcript-label {
            color: #3b82f6;
            /* primary */
        }

        .transcript-bubble {
            padding: 1rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            /* text-sm */
            line-height: 1.6;
            word-wrap: break-word;
            white-space: pre-wrap;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* Agent Bubble (Right) */
        .transcript-message.agent .transcript-bubble {
            background-color: #27272a;
            /* surfaceHighlight */
            color: #fafafa;
            border-top-right-radius: 0.25rem;
        }

        /* Customer Bubble (Left) */
        .transcript-message.customer .transcript-bubble {
            background-color: rgba(59, 130, 246, 0.15);
            /* primary/15 */
            border: 1px solid rgba(59, 130, 246, 0.2);
            color: #fafafa;
            border-top-left-radius: 0.25rem;
        }

        .transcript-bubble.partial {
            opacity: 0.7;
            border-style: dashed;
        }

        /* Personal Note (Center) */
        .transcript-message.note {
            align-self: center;
            max-width: 90%;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .transcript-message.note .transcript-bubble {
            background-color: rgba(255, 255, 255, 0.05);
            color: #fbbf24;
            /* amber-400 */
            font-style: italic;
            text-align: center;
            border: 1px dashed rgba(251, 191, 36, 0.3);
            padding: 0.75rem 1.5rem;
            font-size: 0.8rem;
        }

        /* STAGES / PROGRESS BAR */
        .stage-step.active {
            opacity: 1;
        }

        .stage-step.active .step-dot {
            background-color: #09090b;
            /* surface */
            border-color: #3b82f6;
            /* primary */
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            transform: scale(1.1);
        }

        .stage-step.active .step-glow {
            opacity: 0.3;
            animation: ping-slow 2s infinite;
        }

        .stage-step.completed {
            opacity: 1;
        }

        .stage-step.completed .step-dot {
            background-color: #3b82f6;
            /* primary */
            border-color: #3b82f6;
        }

        @keyframes ping-slow {
            0% {
                transform: scale(1);
                opacity: 0.4;
            }

            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        /* CUSTOM SCROLLBAR FOR LEFT PANEL */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .custom-scrollbar:hover::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="flex flex-col">

    <!-- Navbar -->
    <nav class="h-16 border-b border-white/5 bg-surface/50 backdrop-blur flex items-center justify-between px-6 relative"
        style="z-index: 100;">
        <div class="flex items-center gap-3">
            <div
                class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-accent flex items-center justify-center font-bold text-lg">
                S</div>
            <span class="font-bold text-lg tracking-tight">Sales<span class="text-primary">Coach</span></span>
        </div>
        <div class="flex items-center gap-4">
            <div
                class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-surfaceHighlight border border-white/5 text-sm text-green-400">
                <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                <span>××—×•×‘×¨ (Online)</span>
            </div>
            <button id="btn-settings" onclick="openHealthCheck()" type="button"
                class="w-8 h-8 rounded-full bg-surfaceHighlight flex items-center justify-center hover:bg-white/10 transition cursor-pointer relative"
                style="z-index: 101;">âš™ï¸</button>
        </div>
    </nav>

    <!-- Health Check Modal -->
    <div id="health-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-surface border border-white/10 rounded-2xl p-6 w-96 max-w-[90vw]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">×‘×¨×™××•×ª ×”××¢×¨×›×ª</h2>
                <button onclick="closeHealthCheck()" class="text-textMuted hover:text-white">âœ•</button>
            </div>

            <div id="health-content" class="space-y-4">
                <div class="text-center py-8 text-textMuted">
                    <div class="animate-spin text-2xl mb-2">â³</div>
                    ×‘×•×“×§ ××¢×¨×›×•×ª...
                </div>
            </div>

            <button onclick="openHealthCheck()"
                class="mt-6 w-full py-2 bg-surfaceHighlight rounded-lg text-sm hover:bg-white/10 transition">
                ×¨×¢× ×Ÿ
            </button>
        </div>
    </div>

    <!-- Main Grid -->
    <main class="flex-1 grid grid-cols-12 gap-0 overflow-hidden">

        <!-- LEFT COLUMN: Controls & Analysis (3 Columns) -->
        <aside class="col-span-3 border-l border-white/5 bg-surface/30 flex flex-col overflow-hidden">

            <!-- 1. Dialer Section -->
            <div class="p-6 border-b border-white/5">
                <div class="bg-surfaceHighlight/50 p-1 rounded-2xl border border-white/5 mb-4 shadow-inner">
                    <input type="tel" id="phone-input"
                        class="w-full bg-transparent text-center text-2xl font-mono py-4 focus:outline-none text-white tracking-widest placeholder-white/10 font-bold"
                        placeholder="050-000-0000">
                </div>

                <div class="grid grid-cols-2 gap-3 mb-2">
                    <button onclick="startCall()" id="btn-call"
                        class="col-span-2 py-4 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl font-bold flex items-center justify-center gap-2 hover:shadow-lg hover:shadow-green-500/20 transition-all transform active:scale-95 text-lg">
                        <span>ğŸ“</span> ×—×™×™×’
                    </button>
                    <button onclick="hangup()" id="btn-hangup"
                        class="col-span-2 hidden py-4 bg-red-500/10 border border-red-500/20 text-red-500 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-red-500/20 transition-all text-lg">
                        <span>â›”</span> × ×ª×§
                    </button>
                </div>
                <div id="call-status-text" class="text-center text-xs text-textMuted h-4 font-medium tracking-wide">××•×›×Ÿ
                </div>
            </div>

            <!-- 2. Live Analysis (Score & Insight) -->
            <div class="flex-1 overflow-y-auto custom-scrollbar">

                <!-- Score Ring Container -->
                <div class="p-6 pb-2 text-center relative">
                    <h3 class="text-xs font-bold text-textMuted uppercase tracking-wider mb-4 opacity-70">×¦×™×•×Ÿ ××™×›×•×ª
                        ×©×™×—×”</h3>
                    <div class="relative w-40 h-40 mx-auto mb-4">
                        <svg class="w-full h-full transform -rotate-90 filter drop-shadow-2xl">
                            <circle cx="50%" cy="50%" r="45%" stroke="#27272a" stroke-width="8" fill="transparent" />
                            <circle cx="50%" cy="50%" r="45%" stroke="currentColor" stroke-width="8" fill="transparent"
                                class="text-primary stroke-dasharray-350 stroke-dashoffset-100 transition-all duration-1000"
                                id="score-ring" stroke-linecap="round" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-5xl font-black tracking-tighter" id="score-val">--</span>
                        </div>
                    </div>
                </div>

                <!-- AI Insight Card -->
                <div class="px-6 pb-6">
                    <div id="ai-insight-card"
                        class="glass-panel p-5 rounded-2xl relative overflow-hidden group transition-all duration-300 border border-white/10 bg-gradient-to-br from-surface to-surfaceHighlight/50">
                        <div
                            class="absolute top-0 right-0 w-1 h-full bg-gradient-to-b from-primary to-accent opacity-80">
                        </div>

                        <div class="flex items-center gap-2 mb-3">
                            <div class="p-1.5 bg-primary/10 rounded-lg">
                                <span class="text-lg">ğŸ’¡</span>
                            </div>
                            <span class="font-bold text-sm text-primary uppercase tracking-wide">×§×•××•×¦'×¨ AI</span>
                        </div>

                        <div id="insight-text" class="font-medium text-lg leading-relaxed mb-4 text-white/90">
                            ×××ª×™×Ÿ ×œ×ª×—×™×œ×ª ×”×©×™×—×”...
                        </div>

                        <div id="insight-suggestion"
                            class="hidden text-sm text-textMuted bg-black/20 p-3 rounded-lg border-r-2 border-primary/50 italic leading-relaxed">

                        </div>
                    </div>
                </div>

            </div>
        </aside>

        <!-- RIGHT COLUMN: Chat & Stages (9 Columns) -->
        <div class="col-span-9 flex flex-col bg-background relative h-full overflow-hidden">

            <!-- Top Bar: Header + Stages -->
            <div class="border-b border-white/5 bg-surface/20 backdrop-blur z-20 flex flex-col">

                <!-- Info Row -->
                <div class="h-12 flex items-center justify-between px-6 border-b border-white/5">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-primary/50"></span>
                            <span class="text-sm font-medium text-textMuted">×œ×§×•×—:</span>
                            <span id="active-contact" class="font-mono font-bold tracking-wide text-white">--</span>
                        </div>
                    </div>
                    <div id="call-timer" class="font-mono text-xl text-primary font-bold opacity-0 transition-opacity">
                        00:00</div>
                </div>

                <!-- STAGES PROGRESS BAR -->
                <div class="px-8 py-4 bg-surface/30">
                    <div class="flex justify-between items-center relative gap-4">
                        <!-- Progress Line Background -->
                        <div class="absolute top-1/2 left-0 w-full h-1 bg-white/5 -z-10 rounded-full"></div>

                        <!-- Stage Items -->
                        <div class="stage-step relative flex flex-col items-center gap-2 z-10 opacity-40 transition-all duration-300"
                            data-stage="×¤×ª×™×—×”">
                            <div
                                class="w-4 h-4 rounded-full bg-surface border-2 border-textMuted relative step-dot transition-all">
                                <div
                                    class="absolute inset-0 bg-primary opacity-0 rounded-full transition-all step-glow">
                                </div>
                            </div>
                            <span class="text-xs font-bold whitespace-nowrap">×¤×ª×™×—×” ×•×—×™×‘×•×¨</span>
                        </div>

                        <div class="stage-step relative flex flex-col items-center gap-2 z-10 opacity-40 transition-all duration-300"
                            data-stage="×’×™×œ×•×™ ×¦×¨×›×™×">
                            <div
                                class="w-4 h-4 rounded-full bg-surface border-2 border-textMuted relative step-dot transition-all">
                            </div>
                            <span class="text-xs font-bold whitespace-nowrap">×’×™×œ×•×™ ×¦×¨×›×™×</span>
                        </div>

                        <div class="stage-step relative flex flex-col items-center gap-2 z-10 opacity-40 transition-all duration-300"
                            data-stage="×”×¦×’×ª ×¤×ª×¨×•×Ÿ">
                            <div
                                class="w-4 h-4 rounded-full bg-surface border-2 border-textMuted relative step-dot transition-all">
                            </div>
                            <span class="text-xs font-bold whitespace-nowrap">×”×¦×’×ª ×¤×ª×¨×•×Ÿ</span>
                        </div>

                        <div class="stage-step relative flex flex-col items-center gap-2 z-10 opacity-40 transition-all duration-300"
                            data-stage="×”×¦×’×ª ××—×™×¨">
                            <div
                                class="w-4 h-4 rounded-full bg-surface border-2 border-textMuted relative step-dot transition-all">
                            </div>
                            <span class="text-xs font-bold whitespace-nowrap">×”×¦×’×ª ××—×™×¨</span>
                        </div>

                        <div class="stage-step relative flex flex-col items-center gap-2 z-10 opacity-40 transition-all duration-300"
                            data-stage="×”×ª× ×’×“×•×™×•×ª">
                            <div
                                class="w-4 h-4 rounded-full bg-surface border-2 border-textMuted relative step-dot transition-all">
                            </div>
                            <span class="text-xs font-bold whitespace-nowrap">×˜×™×¤×•×œ ×‘×”×ª× ×’×“×•×™×•×ª</span>
                        </div>

                        <div class="stage-step relative flex flex-col items-center gap-2 z-10 opacity-40 transition-all duration-300"
                            data-stage="×¡×’×™×¨×”">
                            <div
                                class="w-4 h-4 rounded-full bg-surface border-2 border-textMuted relative step-dot transition-all">
                            </div>
                            <span class="text-xs font-bold whitespace-nowrap">×¡×’×™×¨×”</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Feed -->
            <div id="transcript-panel">
                <div id="transcript-scroll" class="transcript-scroll scroll-smooth">
                    <div class="text-center py-20 opacity-30" id="empty-state">
                        <div class="text-6xl mb-4 grayscale">ğŸ’¬</div>
                        <div class="text-lg font-light">×”×ª××œ×•×œ ×™×•×¤×™×¢ ×›××Ÿ ×‘×–××Ÿ ×××ª</div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-6 border-t border-white/5 bg-surface/60 backdrop-blur absolute bottom-0 w-full z-30">
                <div class="relative max-w-4xl mx-auto">
                    <input type="text" id="note-input"
                        class="w-full bg-surfaceHighlight border border-white/10 rounded-xl px-4 py-4 pl-12 focus:outline-none focus:border-primary/50 transition placeholder-textMuted shadow-lg"
                        placeholder="×”×•×¡×£ ×”×¢×¨×” ××™×©×™×ª ××• ×¡×™×›×•×...">
                    <span
                        class="absolute left-4 top-4 text-textMuted text-xs font-mono border border-white/10 px-1.5 py-0.5 rounded">â†µ
                        ENTER</span>
                </div>
            </div>
        </div>

    </main>

    <script>console.log('Attempting to load Twilio SDK...');</script>
    <!-- Twilio Voice SDK v2.11.1 (via jsDelivr) -->
    <script src="https://cdn.jsdelivr.net/npm/@twilio/voice-sdk@2.11.1/dist/twilio.min.js"
        onload="console.log('Twilio Voice SDK Loaded')" onerror="handleSdkLoadError()"></script>
    <script>
            function handleSdkLoadError() {
            const statusText = document.getElementById('call-status-text');
            console.error('Twilio SDK Load Failed (Network/Block).');
            statusText.innerText = '×©×’×™××”: ×˜×¢×™× ×ª ×¨×›×™×‘ ×”×©×™×—×” × ×›×©×œ×”. × ×¡×” ×œ×¨×¢× ×Ÿ.';
            statusText.classList.add('text-red-500');

            // Optional: Create a retry button
            const container = statusText.parentElement;
            if (!document.getElementById('retry-sdk-btn')) {
                const retryBtn = document.createElement('button');
                retryBtn.id = 'retry-sdk-btn';
                retryBtn.innerText = '× ×¡×” ×©×•×‘';
                retryBtn.className = 'mt-2 px-3 py-1 bg-white/10 rounded text-xs hover:bg-white/20 transition';
                retryBtn.onclick = () => window.location.reload();
                container.appendChild(retryBtn);
            }
        }
    </script>
    <script>
        // State
        let isCallActive = false;
        let callTimer = null;
        let seconds = 0;
        let ws = null;
        let activeConnection = null;
        let device = null;
        let callSid = null; // Will be set from Twilio Connection

        const btnCall = document.getElementById('btn-call');
        const btnHangup = document.getElementById('btn-hangup');
        const inputPhone = document.getElementById('phone-input');
        const statusText = document.getElementById('call-status-text');
        const timerDisplay = document.getElementById('call-timer');
        const activeContact = document.getElementById('active-contact');
        const feed = document.getElementById('transcript-feed');

        // --- INIT DEVICE ON LOAD ---
        async function initDevice() {
            try {
                console.log('Fetching token from /api/token...');
                statusText.innerText = "×˜×•×¢×Ÿ ×—×™×‘×•×¨ ×œ×˜×œ×¤×•×Ÿ...";

                const res = await fetch('/api/token');
                if (!res.ok) throw new Error(`Token fetch failed: ${res.status} ${res.statusText}`);

                const data = await res.json();
                console.log('Token received:', data);

                // Twilio Voice SDK v2 Initialization
                // Note: The global might be Twilio.Device or Twilio.Voice.Device depending on the bundle.
                // The CDN usually exposes Twilio.Device directly or via Twilio.Voice.
                const Device = Twilio.Device;

                device = new Device(data.token, {
                    codecPreferences: ['opus', 'pcmu'],
                    // fakeLocalDTMF, enableRingingState are v1 legacy options - removed
                    debug: true,
                    // v2 specific options can go here
                });

                // Register the device for incoming calls
                device.register();

                device.on('registered', function () {
                    console.log('Twilio.Device Ready (Registered)!');
                    statusText.innerText = "××•×›×Ÿ ×œ×©×™×—×” (Voice SDK v2)";
                    statusText.classList.remove('text-red-500');
                    statusText.classList.add('text-green-400');
                });

                device.on('error', function (error) {
                    console.error('Twilio.Device Error:', error);
                    // Ignore some harmless errors or handle them
                    if (error.code === 31205) return; // Keep alive error, ignore
                    statusText.innerText = "×©×’×™××”: " + error.message;
                    statusText.classList.add('text-red-500');
                });

                // In v2, 'connect' event on device is for unexpected connections? 
                // Usually we handle outgoing via the promise, and incoming via 'incoming' event.
                // We'll leave this empty or use it for debugging.

            } catch (err) {
                console.error('CRITICAL Error during Device init:', err);
                statusText.innerText = "×©×’×™××ª ××ª×—×•×œ: " + err.message;
                statusText.classList.add('text-red-500');
            }
        }

        // --- INIT DEVICE ON LOAD ---
        window.addEventListener('load', () => {
            // Check if we are blocked
            if (statusText.innerText.includes('AdBlock')) return;

            // Start polling for the SDK
            waitForTwilio();
        });

        function waitForTwilio(attempts = 0) {
            if (typeof Twilio !== 'undefined') {
                console.log('Twilio global found. Initializing...');
                initDevice();
                return;
            }

            if (attempts > 50) { // 5 seconds (50 * 100ms)
                console.error('Twilio SDK load timed out.');
                statusText.innerText = "×©×’×™××”: ×˜×¢×™× ×ª ×”×¨×›×™×‘×™× ××™×˜×™×ª ××“×™. × ×¡×” ×œ×¨×¢× ×Ÿ.";
                statusText.classList.add('text-red-500');
                // Allow a manual retry button here too if needed
                handleSdkLoadError(); // re-use error handler to show retry
                return;
            }

            if (attempts % 10 === 0) {
                // Update UI every second
                if (!statusText.innerText.includes('×©×’×™××”')) {
                    statusText.innerText = `×˜×•×¢×Ÿ ×¨×›×™×‘×™×... (${Math.floor(attempts / 10)})`;
                }
            }

            setTimeout(() => waitForTwilio(attempts + 1), 100);
        }

        // Functions
        async function startCall() {
            const phone = inputPhone.value;
            if (!phone) {
                inputPhone.classList.add('border-red-500');
                setTimeout(() => inputPhone.classList.remove('border-red-500'), 2000);
                return;
            }

            if (!device) {
                alert('Device not initialized yet. Please wait.');
                return;
            }

            statusText.innerText = "××ª×§×©×¨...";
            activeContact.innerText = phone;
            // feed.innerHTML = ''; // Clean feed - This line is removed as per the refactor, transcript-scroll is now the feed.

            try {
                // Connect via WebRTC (v2)
                // device.connect() returns a Promise resolving to a Call object
                const params = {
                    target_number: phone
                };

                console.log('Dialing ' + phone + '...');
                const call = await device.connect({ params: params });

                // Setup Call Listeners
                call.on('accept', () => {
                    console.log('Call accepted');
                    statusText.innerText = "×‘×©×™×—×”";
                    activeConnection = call;
                    // v2: call.parameters.CallSid contains the Sid
                    callSid = call.parameters.CallSid;
                    setCallState(true);
                    startTimer();
                    connectWS(callSid);
                });

                call.on('disconnect', () => {
                    console.log('Call disconnected');
                    statusText.innerText = "×”×©×™×—×” ×”×¡×ª×™×™××”";
                    activeConnection = null;
                    hangup();
                });

                call.on('error', (err) => {
                    console.error('Call Error:', err);
                    statusText.innerText = "×©×’×™××” ×‘×©×™×—×”";
                });

            } catch (e) {
                console.error('Connection failed:', e);
                statusText.innerText = "×©×’×™××” ×‘×—×™×•×’: " + e.message;
                setTimeout(() => setCallState(false), 2000);
            }
        }

        async function hangup() {
            if (activeConnection) {
                activeConnection.disconnect();
            } else if (device) {
                device.disconnectAll();
            }

            setCallState(false);
            // Optional: Redirect to summary only if a real call happened
            // window.location.href = '/summary.html'; 
        }

        function setCallState(active) {
            isCallActive = active;
            if (active) {
                btnCall.classList.add('hidden');
                btnHangup.classList.remove('hidden');
                timerDisplay.classList.remove('opacity-0');
            } else {
                btnCall.classList.remove('hidden');
                btnHangup.classList.add('hidden');
                timerDisplay.classList.add('opacity-0');
                clearInterval(callTimer);
                seconds = 0;
            }
        }

        function startTimer() {
            clearInterval(callTimer);
            callTimer = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                timerDisplay.innerText = `${m}:${s}`;
            }, 1000);
        }

        function connectWS(sid) {
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${proto}//${location.host}/ws/coach?callSid=${sid}`);

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('[WS] Received:', data.type, data);
                if (data.type === 'transcript') addTranscriptItem(data);
                if (data.type === 'coaching') updateInsight(data);
                if (data.type === 'call_summary') {
                    console.log('Call Summary Received:', data.data);
                    sessionStorage.setItem('lastCallSummary', JSON.stringify(data.data));
                    window.location.href = '/summary.html';
                }
            };
        }

        // Transcript Logic



        // --- NEW TRANSCRIPT LOGIC ---

        function scrollTranscriptToBottom() {
            const el = document.getElementById('transcript-scroll');
            if (!el) return;
            // Native smooth scroll behavior from CSS, but force top position
            requestAnimationFrame(() => {
                el.scrollTop = el.scrollHeight;
            });
        }

        function addTranscriptItem(data) {
            // Target the scroll container directly as the feed
            const feed = document.getElementById('transcript-scroll');
            const emptyState = document.getElementById('empty-state');
            if (emptyState) emptyState.style.display = 'none';

            // Data prep
            const role = data.role; // 'agent' or 'customer' or 'note'
            let text = data.text || '';
            const isFinal = data.isFinal !== false;

            // Cleanup 
            text = text.replace(/<end>/gi, '').trim();
            if (!text) return;

            // Check for existing partial bubble to update
            const lastItem = feed.lastElementChild;
            const lastWasPartial = lastItem && lastItem.dataset.partial === 'true';
            const lastWasSameSpeaker = lastItem && lastItem.dataset.speaker === role;

            if (lastWasPartial && lastWasSameSpeaker) {
                // UPDATE existing bubble
                const bubble = lastItem.querySelector('.transcript-bubble');
                if (bubble) bubble.innerText = text;

                if (isFinal) {
                    lastItem.dataset.partial = 'false';
                    if (bubble) bubble.classList.remove('partial');
                    const typingEl = lastItem.querySelector('.typing-indicator');
                    if (typingEl) typingEl.remove();
                }

                scrollTranscriptToBottom();
                return;
            }

            // CREATE new bubble
            const messageEl = document.createElement('div');
            // Add specific classes
            messageEl.className = 'transcript-message';
            messageEl.classList.add(role);
            if (!isFinal) messageEl.classList.add('new');

            messageEl.dataset.speaker = role;
            messageEl.dataset.partial = (!isFinal).toString();

            // Label (skip for notes)
            if (role !== 'note') {
                const labelEl = document.createElement('div');
                labelEl.classList.add('transcript-label');

                const nameSpan = document.createElement('span');
                nameSpan.textContent = (role === 'agent') ? '× ×¦×™×’' : '×œ×§×•×—';
                labelEl.appendChild(nameSpan);

                if (!isFinal) {
                    const typingSpan = document.createElement('span');
                    typingSpan.classList.add('typing-indicator', 'text-[10px]', 'animate-pulse', 'opacity-70');
                    typingSpan.innerText = '××§×œ×™×“...';
                    labelEl.appendChild(typingSpan);
                }
                messageEl.appendChild(labelEl);
            }

            // Bubble
            const bubbleEl = document.createElement('div');
            bubbleEl.classList.add('transcript-bubble');
            if (!isFinal) bubbleEl.classList.add('partial');
            bubbleEl.innerText = text;

            messageEl.appendChild(bubbleEl);

            feed.appendChild(messageEl);
            scrollTranscriptToBottom();
        }

        function updateInsight(data) {
            // 1. Update Score
            if (typeof data.score === 'number') {
                const scoreVal = document.getElementById('score-val');
                const scoreRing = document.getElementById('score-ring');

                scoreVal.innerText = data.score;

                // Ring calculation (circumference ~ 350)
                // 100 score = 0 offset, 0 score = 350 offset
                const offset = 350 - (data.score * 3.5);
                scoreRing.style.strokeDashoffset = offset;

                // Color grading
                if (data.score > 80) scoreRing.classList.add('text-green-500');
                else if (data.score < 50) scoreRing.classList.add('text-red-500');
                else scoreRing.className = 'text-primary stroke-dasharray-350 stroke-dashoffset-100 transition-all duration-1000'; // Reset/Default
            }

            // 2. Update Stage (Horizontal Progress Bar)
            if (data.stage) {
                const stages = document.querySelectorAll('.stage-step');
                let foundCurrent = false;

                stages.forEach(step => {
                    const stageName = step.dataset.stage;

                    if (data.stage.includes(stageName)) {
                        // This is the current active stage
                        step.classList.add('active');
                        step.classList.remove('completed');
                        step.querySelector('.step-dot').classList.add('bg-surface'); // Reset dot fill for active
                        foundCurrent = true;
                    } else if (!foundCurrent) {
                        // Previous stages - Mark as completed
                        step.classList.add('completed');
                        step.classList.remove('active');
                    } else {
                        // Future stages - Reset
                        step.classList.remove('active', 'completed');
                    }
                });
            }

            // 3. Insight & Suggestion
            const card = document.getElementById('ai-insight-card');
            const textEl = document.getElementById('insight-text');
            const suggestEl = document.getElementById('insight-suggestion');

            // Flash effect
            card.classList.add('border-primary');
            setTimeout(() => card.classList.remove('border-primary'), 500);

            // Message is the short analysis
            if (data.message) {
                textEl.innerText = data.message;
            }

            // Suggested Reply
            if (data.suggested_reply) {
                suggestEl.innerText = `"${data.suggested_reply}"`;
                suggestEl.classList.remove('hidden');
            } else {
                suggestEl.classList.add('hidden');
            }
        }

        // --- DEV SHORTCUT ---
        document.addEventListener('keydown', (e) => {
            if (e.shiftKey && e.key === 'S') {
                if (!isCallActive) startCall();
                setTimeout(() => addTranscriptItem({ role: 'agent', text: '×©×œ×•×, ×›××Ÿ ×™×•×¡×™ ××—×‘×¨×ª ×¡×™×™×œ×¡.' }), 1000);
                setTimeout(() => addTranscriptItem({ role: 'customer', text: '×”×™×™, ×ª×’×™×“ ×›××” ×¢×•×œ×” ×”×× ×•×™?' }), 2500);
                setTimeout(() => updateInsight({ message: '×”×œ×§×•×— ×©×•××œ ×¢×œ ××—×™×¨ ××•×§×“× ××“×™.', suggested_reply: '×¢×“×™×£ ×§×•×“× ×œ×”×‘×™×Ÿ ××ª ×”×¦×¨×›×™×. × ×¡×”: "×œ×¤× ×™ ×©× ×“×‘×¨ ×¢×œ ××—×™×¨, ×—×©×•×‘ ×œ×™ ×œ×”×‘×™×Ÿ ××” ×‘×“×™×•×§ ××ª× ×¦×¨×™×›×™× ×›×“×™ ×œ×ª×ª ×”×¦×¢×” ××“×•×™×§×ª."' }), 3500);
            }
        });

        // --- PERSONAL NOTES ---
        const noteInput = document.getElementById('note-input');
        if (noteInput) {
            noteInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const text = noteInput.value.trim();
                    if (text) {
                        // Add note to transcript
                        addTranscriptItem({
                            role: 'note',
                            text: text,
                            isFinal: true
                        });
                        noteInput.value = '';
                    }
                }
            });
        }

        // --- HEALTH CHECK ---
        async function openHealthCheck() {
            const modal = document.getElementById('health-modal');
            const content = document.getElementById('health-content');

            modal.classList.remove('hidden');
            content.innerHTML = `<div class="text-center py-8 text-textMuted">
                <div class="animate-spin text-2xl mb-2">â³</div>
                ×‘×•×“×§ ××¢×¨×›×•×ª...
            </div>`;

            try {
                const res = await fetch('/api/health');
                const data = await res.json();

                const statusIcon = (status) => {
                    if (status === 'ok') return 'ğŸŸ¢';
                    if (status === 'error') return 'ğŸ”´';
                    if (status === 'not_configured') return 'ğŸŸ¡';
                    return 'âšª';
                };

                const statusText = (status) => {
                    if (status === 'ok') return '×ª×§×™×Ÿ';
                    if (status === 'error') return '×©×’×™××”';
                    if (status === 'not_configured') return '×œ× ××•×’×“×¨';
                    return '×œ× ×™×“×•×¢';
                };

                content.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-surfaceHighlight/30 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${statusIcon(data.server.status)}</span>
                                <span class="font-medium">Server</span>
                            </div>
                            <span class="text-sm text-textMuted">Uptime: ${data.server.uptime}s</span>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-surfaceHighlight/30 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${statusIcon(data.twilio.status)}</span>
                                <span class="font-medium">Twilio</span>
                            </div>
                            <span class="text-sm text-textMuted">${data.twilio.message || statusText(data.twilio.status)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-surfaceHighlight/30 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${statusIcon(data.soniox.status)}</span>
                                <span class="font-medium">Soniox (×ª××œ×•×œ)</span>
                            </div>
                            <span class="text-sm text-textMuted">${data.soniox.message || statusText(data.soniox.status)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-surfaceHighlight/30 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${statusIcon(data.openai.status)}</span>
                                <span class="font-medium">OpenAI (AI)</span>
                            </div>
                            <span class="text-sm text-textMuted">${data.openai.message || statusText(data.openai.status)}</span>
                        </div>
                    </div>
                `;
            } catch (e) {
                content.innerHTML = `<div class="text-center py-8 text-red-400">
                    ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×
                </div>`;
            }
        }

        function closeHealthCheck() {
            document.getElementById('health-modal').classList.add('hidden');
        }
    </script>
</body>

</html>