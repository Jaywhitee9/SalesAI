<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Coach AI - Dashboard</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Heebo:wght@300;400;500;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: '#09090b',
                        surface: '#18181b',
                        surfaceHighlight: '#27272a',
                        primary: '#3b82f6',
                        primaryGlow: 'rgba(59, 130, 246, 0.5)',
                        accent: '#8b5cf6',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        textMain: '#fafafa',
                        textMuted: '#a1a1aa'
                    },
                    fontFamily: {
                        sans: ['Heebo', 'Outfit', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #09090b;
            color: #fafafa;
            height: 100vh;
            overflow: hidden;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #27272a;
            border-radius: 3px;
        }

        .glass-panel {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }
    </style>
</head>

<body class="flex flex-col">

    <!-- Navbar -->
    <nav class="h-16 border-b border-white/5 bg-surface/50 backdrop-blur flex items-center justify-between px-6 z-50">
        <div class="flex items-center gap-3">
            <div
                class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-accent flex items-center justify-center font-bold text-lg">
                S</div>
            <span class="font-bold text-lg tracking-tight">Sales<span class="text-primary">Coach</span></span>
        </div>
        <div class="flex items-center gap-4">
            <div
                class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-surfaceHighlight border border-white/5 text-sm text-green-400">
                <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                <span>××—×•×‘×¨ (Online)</span>
            </div>
            <button
                class="w-8 h-8 rounded-full bg-surfaceHighlight flex items-center justify-center hover:bg-white/10 transition">âš™ï¸</button>
        </div>
    </nav>

    <!-- Main Grid -->
    <main class="flex-1 grid grid-cols-12 gap-0 overflow-hidden">

        <!-- LEFT COLUMN: Dialer & Stats (3 Columns) -->
        <aside class="col-span-3 border-l border-white/5 bg-surface/30 flex flex-col">
            <div class="p-6 border-b border-white/5">
                <h2 class="text-xs font-bold text-textMuted uppercase tracking-wider mb-4">×—×™×™×’×Ÿ</h2>

                <!-- Dialer -->
                <div class="bg-surfaceHighlight/50 p-1 rounded-2xl border border-white/5 mb-4">
                    <input type="tel" id="phone-input"
                        class="w-full bg-transparent text-center text-xl font-mono py-4 focus:outline-none text-white tracking-widest placeholder-white/20"
                        placeholder="050-000-0000">
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="startCall()" id="btn-call"
                        class="col-span-2 py-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl font-bold flex items-center justify-center gap-2 hover:shadow-lg hover:shadow-green-500/20 transition-all transform active:scale-95">
                        <span>ğŸ“</span> ×—×™×™×’ ×¢×›×©×™×•
                    </button>
                    <button onclick="hangup()" id="btn-hangup"
                        class="col-span-2 hidden py-3 bg-red-500/10 border border-red-500/20 text-red-500 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-red-500/20 transition-all">
                        <span>â›”</span> ×¡×™×™× ×©×™×—×”
                    </button>
                </div>

                <!-- Status Text -->
                <div id="call-status-text" class="text-center text-sm text-textMuted h-6">××•×›×Ÿ ×œ×©×™×—×”</div>
            </div>

            <!-- Stats / History -->
            <div class="flex-1 overflow-y-auto p-4">
                <h3 class="text-xs font-bold text-textMuted uppercase tracking-wider mb-3">×©×™×—×•×ª ××—×¨×•× ×•×ª</h3>
                <div class="space-y-2">
                    <div
                        class="p-3 rounded-lg bg-surfaceHighlight/30 border border-white/5 flex justify-between items-center text-sm hover:bg-surfaceHighlight/50 cursor-pointer transition">
                        <div>
                            <div class="font-medium">×“× ×™××œ ×›×”×Ÿ</div>
                            <div class="text-xs text-textMuted">×œ×¤× ×™ 15 ×“×§'</div>
                        </div>
                        <div class="px-2 py-0.5 rounded bg-green-500/10 text-green-400 text-xs">85 × ×§'</div>
                    </div>
                    <div
                        class="p-3 rounded-lg bg-surfaceHighlight/30 border border-white/5 flex justify-between items-center text-sm hover:bg-surfaceHighlight/50 cursor-pointer transition">
                        <div>
                            <div class="font-medium">×©×¨×” ×œ×•×™</div>
                            <div class="text-xs text-textMuted">×œ×¤× ×™ 42 ×“×§'</div>
                        </div>
                        <div class="px-2 py-0.5 rounded bg-yellow-500/10 text-yellow-400 text-xs">60 × ×§'</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CENTER COLUMN: Transcript (6 Columns) -->
        <div class="col-span-6 flex flex-col bg-background relative">
            <!-- Header -->
            <div
                class="h-14 border-b border-white/5 flex items-center justify-between px-6 bg-surface/20 backdrop-blur z-10">
                <div class="flex items-center gap-3">
                    <span class="text-sm font-medium text-textMuted">×©×™×—×” ×¤×¢×™×œ×”:</span>
                    <span id="active-contact" class="font-mono font-bold tracking-wide">--</span>
                </div>
                <div id="call-timer"
                    class="font-mono text-xl text-primary font-bold opacity-0 transition-opacity duration-300">00:00
                </div>
            </div>

            <!-- Feed -->
            <div id="transcript-feed" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth pb-24">
                <div class="text-center py-20 opacity-30">
                    <div class="text-6xl mb-4">ğŸ’¬</div>
                    <div class="text-lg">×”×ª××œ×•×œ ×™×•×¤×™×¢ ×›××Ÿ ×‘×–××Ÿ ×××ª</div>
                </div>
            </div>

            <!-- Input Area (Notes) -->
            <div class="p-4 border-t border-white/5 bg-surface/40 backdrop-blur absolute bottom-0 w-full">
                <div class="relative">
                    <input type="text"
                        class="w-full bg-surfaceHighlight border border-white/10 rounded-xl px-4 py-3 pl-10 focus:outline-none focus:border-primary/50 transition placeholder-textMuted"
                        placeholder="×”×•×¡×£ ×”×¢×¨×” ××™×©×™×ª...">
                    <span class="absolute left-3 top-3.5 opacity-50">â†µ</span>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Coach AI (3 Columns) -->
        <aside class="col-span-3 border-r border-white/5 bg-surface/30 flex flex-col overflow-hidden">

            <!-- Live Analysis Header -->
            <div class="p-5 border-b border-white/5">
                <h2 class="text-xs font-bold text-textMuted uppercase tracking-wider mb-4">Live Analysis</h2>

                <!-- Meter -->
                <div class="relative h-32 flex items-center justify-center mb-2">
                    <svg class="w-32 h-32 transform -rotate-90">
                        <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="8" fill="transparent"
                            class="text-surfaceHighlight" />
                        <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="8" fill="transparent"
                            class="text-primary stroke-dasharray-350 stroke-dashoffset-100 transition-all duration-1000"
                            id="score-ring" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-3xl font-bold" id="score-val">--</span>
                        <span class="text-[10px] text-textMuted uppercase mt-1">×¦×™×•×Ÿ ×”×ª×××”</span>
                    </div>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-5 space-y-6">

                <!-- AI Insight Card -->
                <div id="ai-insight-card"
                    class="glass-panel p-5 rounded-2xl relative overflow-hidden group transition-all duration-300 hover:border-primary/30">
                    <div class="absolute top-0 right-0 w-1 h-full bg-gradient-to-b from-primary to-accent"></div>
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-lg animate-bounce">ğŸ’¡</span>
                        <span class="font-bold text-sm text-primary uppercase tracking-wide">×”××œ×¦×” ×—×›××”</span>
                    </div>
                    <div id="insight-text" class="font-medium text-lg leading-relaxed mb-3">
                        ×”××¢×¨×›×ª ×××ª×™× ×” ×œ× ×ª×•× ×™×...
                    </div>
                    <div id="insight-suggestion"
                        class="hidden text-sm text-textMuted bg-white/5 p-3 rounded-lg border-r-2 border-primary/50 italic">
                        "×× ×™ ××‘×™×Ÿ ××ª ×”×—×©×©, ×‘×•× × ×¨××” ××™×š..."
                    </div>
                </div>

                <!-- Checklist -->
                <div>
                    <h3 class="text-xs font-bold text-textMuted uppercase tracking-wider mb-3">×©×œ×‘×™ ×©×™×—×”</h3>
                    <div class="space-y-2">
                        <div
                            class="flex items-center gap-3 p-3 rounded-xl bg-surfaceHighlight/50 border border-white/5 opacity-50">
                            <div class="w-5 h-5 rounded-full border-2 border-white/20"></div>
                            <div class="text-sm">×¤×ª×™×—×” ×•×—×™×‘×•×¨</div>
                        </div>
                        <div
                            class="flex items-center gap-3 p-3 rounded-xl bg-surfaceHighlight/50 border border-white/5 opacity-50">
                            <div class="w-5 h-5 rounded-full border-2 border-white/20"></div>
                            <div class="text-sm">×–×™×”×•×™ ×¦×¨×›×™×</div>
                        </div>
                        <div
                            class="flex items-center gap-3 p-3 rounded-xl bg-surfaceHighlight/50 border border-white/5 opacity-50">
                            <div class="w-5 h-5 rounded-full border-2 border-white/20"></div>
                            <div class="text-sm">×”×¦×’×ª ×¤×ª×¨×•×Ÿ</div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

    </main>

    <script>console.log('Attempting to load Twilio SDK...');</script>
    <!-- Twilio Voice SDK v2.11.1 -->
    <script src="https://sdk.twilio.com/js/voice/releases/2.11.1/twilio.min.js"
        onload="console.log('Twilio Voice SDK Loaded')" onerror="handleSdkLoadError()"></script>
    <script>
        function handleSdkLoadError() {
            const statusText = document.getElementById('call-status-text');
            console.error('Twilio SDK Load Failed (Network/Block).');
            statusText.innerText = '×©×’×™××”: ×˜×¢×™× ×ª ×¨×›×™×‘ ×”×©×™×—×” × ×›×©×œ×”. × ×¡×” ×œ×¨×¢× ×Ÿ.';
            statusText.classList.add('text-red-500');

            // Optional: Create a retry button
            const container = statusText.parentElement;
            if (!document.getElementById('retry-sdk-btn')) {
                const retryBtn = document.createElement('button');
                retryBtn.id = 'retry-sdk-btn';
                retryBtn.innerText = '× ×¡×” ×©×•×‘';
                retryBtn.className = 'mt-2 px-3 py-1 bg-white/10 rounded text-xs hover:bg-white/20 transition';
                retryBtn.onclick = () => window.location.reload();
                container.appendChild(retryBtn);
            }
        }
    </script>
    <script>
        // State
        let isCallActive = false;
        let callTimer = null;
        let seconds = 0;
        let ws = null;
        let activeConnection = null;
        let device = null;
        let callSid = null; // Will be set from Twilio Connection

        const btnCall = document.getElementById('btn-call');
        const btnHangup = document.getElementById('btn-hangup');
        const inputPhone = document.getElementById('phone-input');
        const statusText = document.getElementById('call-status-text');
        const timerDisplay = document.getElementById('call-timer');
        const activeContact = document.getElementById('active-contact');
        const feed = document.getElementById('transcript-feed');

        // --- INIT DEVICE ON LOAD ---
        async function initDevice() {
            try {
                console.log('Fetching token from /api/token...');
                statusText.innerText = "×˜×•×¢×Ÿ ×—×™×‘×•×¨ ×œ×˜×œ×¤×•×Ÿ...";

                const res = await fetch('/api/token');
                if (!res.ok) throw new Error(`Token fetch failed: ${res.status} ${res.statusText}`);

                const data = await res.json();
                console.log('Token received:', data);

                // Twilio Voice SDK v2 Initialization
                // Note: The global might be Twilio.Device or Twilio.Voice.Device depending on the bundle.
                // The CDN usually exposes Twilio.Device directly or via Twilio.Voice.
                const Device = Twilio.Device;

                device = new Device(data.token, {
                    codecPreferences: ['opus', 'pcmu'],
                    // fakeLocalDTMF, enableRingingState are v1 legacy options - removed
                    debug: true,
                    // v2 specific options can go here
                });

                // Register the device for incoming calls
                device.register();

                device.on('registered', function () {
                    console.log('Twilio.Device Ready (Registered)!');
                    statusText.innerText = "××•×›×Ÿ ×œ×©×™×—×” (Voice SDK v2)";
                    statusText.classList.remove('text-red-500');
                    statusText.classList.add('text-green-400');
                });

                device.on('error', function (error) {
                    console.error('Twilio.Device Error:', error);
                    // Ignore some harmless errors or handle them
                    if (error.code === 31205) return; // Keep alive error, ignore
                    statusText.innerText = "×©×’×™××”: " + error.message;
                    statusText.classList.add('text-red-500');
                });

                // In v2, 'connect' event on device is for unexpected connections? 
                // Usually we handle outgoing via the promise, and incoming via 'incoming' event.
                // We'll leave this empty or use it for debugging.

            } catch (err) {
                console.error('CRITICAL Error during Device init:', err);
                statusText.innerText = "×©×’×™××ª ××ª×—×•×œ: " + err.message;
                statusText.classList.add('text-red-500');
            }
        }

        // --- INIT DEVICE ON LOAD ---
        window.addEventListener('load', () => {
            // If we already detected a block via onerror (text contains AdBlock), don't overwrite it
            if (statusText.innerText.includes('AdBlock')) return;

            if (typeof Twilio === 'undefined') {
                console.warn('Twilio SDK not loaded yet. Waiting or Failed.');
                // Don't immediately error, give it a moment or let 'onerror' handle it.
                // Just log it.
                if (!statusText.innerText.includes('×©×’×™××”')) {
                    statusText.innerText = "×˜×•×¢×Ÿ ×¨×›×™×‘×™×...";
                }
                return;
            }
            initDevice();
        });

        // Functions
        async function startCall() {
            const phone = inputPhone.value;
            if (!phone) {
                inputPhone.classList.add('border-red-500');
                setTimeout(() => inputPhone.classList.remove('border-red-500'), 2000);
                return;
            }

            if (!device) {
                alert('Device not initialized yet. Please wait.');
                return;
            }

            statusText.innerText = "××ª×§×©×¨...";
            activeContact.innerText = phone;
            feed.innerHTML = ''; // Clean feed

            try {
                // Connect via WebRTC (v2)
                // device.connect() returns a Promise resolving to a Call object
                const params = {
                    To: phone
                };

                console.log('Dialing ' + phone + '...');
                const call = await device.connect({ params: params });

                // Setup Call Listeners
                call.on('accept', () => {
                    console.log('Call accepted');
                    statusText.innerText = "×‘×©×™×—×”";
                    activeConnection = call;
                    // v2: call.parameters.CallSid contains the Sid
                    callSid = call.parameters.CallSid;
                    setCallState(true);
                    startTimer();
                    connectWS(callSid);
                });

                call.on('disconnect', () => {
                    console.log('Call disconnected');
                    statusText.innerText = "×”×©×™×—×” ×”×¡×ª×™×™××”";
                    activeConnection = null;
                    hangup();
                });

                call.on('error', (err) => {
                    console.error('Call Error:', err);
                    statusText.innerText = "×©×’×™××” ×‘×©×™×—×”";
                });

            } catch (e) {
                console.error('Connection failed:', e);
                statusText.innerText = "×©×’×™××” ×‘×—×™×•×’: " + e.message;
                setTimeout(() => setCallState(false), 2000);
            }
        }

        async function hangup() {
            if (activeConnection) {
                activeConnection.disconnect();
            } else if (device) {
                device.disconnectAll();
            }

            setCallState(false);
            // Optional: Redirect to summary only if a real call happened
            // window.location.href = '/summary.html'; 
        }

        function setCallState(active) {
            isCallActive = active;
            if (active) {
                btnCall.classList.add('hidden');
                btnHangup.classList.remove('hidden');
                timerDisplay.classList.remove('opacity-0');
            } else {
                btnCall.classList.remove('hidden');
                btnHangup.classList.add('hidden');
                timerDisplay.classList.add('opacity-0');
                clearInterval(callTimer);
                seconds = 0;
            }
        }

        function startTimer() {
            clearInterval(callTimer);
            callTimer = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                timerDisplay.innerText = `${m}:${s}`;
            }, 1000);
        }

        function connectWS(sid) {
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${proto}//${location.host}/ws/coach?callSid=${sid}`);

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'transcript') addTranscriptItem(data);
                if (data.type === 'coaching') updateInsight(data);
            };
        }

        function addTranscriptItem(data) {
            const isAgent = data.role === 'agent';
            const div = document.createElement('div');
            div.className = `flex ${isAgent ? 'justify-start' : 'justify-end'} mb-4`;

            div.innerHTML = `
                <div class="max-w-[75%] ${isAgent ? 'bg-surfaceHighlight' : 'bg-primary/20 border border-primary/20'} p-4 rounded-2xl rounded-${isAgent ? 'tr' : 'tl'}-sm">
                    <div class="text-xs ${isAgent ? 'text-textMuted' : 'text-primary'} mb-1 font-bold">${isAgent ? '× ×¦×™×’' : '×œ×§×•×—'}</div>
                    <div class="text-sm leading-relaxed">${data.text}</div>
                </div>
            `;

            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        function updateInsight(data) {
            const card = document.getElementById('ai-insight-card');
            const textEl = document.getElementById('insight-text');
            const suggestEl = document.getElementById('insight-suggestion');

            // Flash effect
            card.classList.add('border-primary');
            setTimeout(() => card.classList.remove('border-primary'), 500);

            textEl.innerText = data.message;
            if (data.suggested_reply) {
                suggestEl.innerText = `"${data.suggested_reply}"`;
                suggestEl.classList.remove('hidden');
            } else {
                suggestEl.classList.add('hidden');
            }
        }

        // --- DEV SHORTCUT ---
        document.addEventListener('keydown', (e) => {
            if (e.shiftKey && e.key === 'S') {
                if (!isCallActive) startCall();
                setTimeout(() => addTranscriptItem({ role: 'agent', text: '×©×œ×•×, ×›××Ÿ ×™×•×¡×™ ××—×‘×¨×ª ×¡×™×™×œ×¡.' }), 1000);
                setTimeout(() => addTranscriptItem({ role: 'customer', text: '×”×™×™, ×ª×’×™×“ ×›××” ×¢×•×œ×” ×”×× ×•×™?' }), 2500);
                setTimeout(() => updateInsight({ message: '×”×œ×§×•×— ×©×•××œ ×¢×œ ××—×™×¨ ××•×§×“× ××“×™.', suggested_reply: '×¢×“×™×£ ×§×•×“× ×œ×”×‘×™×Ÿ ××ª ×”×¦×¨×›×™×. × ×¡×”: "×œ×¤× ×™ ×©× ×“×‘×¨ ×¢×œ ××—×™×¨, ×—×©×•×‘ ×œ×™ ×œ×”×‘×™×Ÿ ××” ×‘×“×™×•×§ ××ª× ×¦×¨×™×›×™× ×›×“×™ ×œ×ª×ª ×”×¦×¢×” ××“×•×™×§×ª."' }), 3500);
            }
        });

    </script>
</body>

</html>