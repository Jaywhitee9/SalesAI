<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SalesFlow AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Heebo', 'Inter', 'sans-serif'],
                        mono: ['Inter', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                            950: '#1e1b4b',
                        },
                        surface: '#18181b', // Dark surface
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-slow': 'pulse 3s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        body {
            background-color: #f8fafc;
            background-image:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.03) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.03) 0px, transparent 50%);
            background-attachment: fixed;
            height: 100vh;
            overflow: hidden;
        }

        /* Transcript Styles */
        .transcript-message {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            margin-bottom: 1rem;
            position: relative;
            animation: fadeIn 0.3s forwards;
        }

        .transcript-message.agent {
            align-self: flex-start;
        }

        /* Right in RTL */
        .transcript-message.customer {
            align-self: flex-end;
        }

        /* Left in RTL */

        .transcript-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        /* Agent Bubble */
        .transcript-message.agent .transcript-bubble {
            background-color: #f1f5f9;
            /* Slate-100 */
            color: #334155;
            /* Slate-700 */
            border-top-right-radius: 0.25rem;
        }

        /* Customer Bubble */
        .transcript-message.customer .transcript-bubble {
            background-color: #eef2ff;
            /* Brand-50 */
            color: #3730a3;
            /* Brand-800 */
            border: 1px solid #e0e7ff;
            border-top-left-radius: 0.25rem;
        }

        .transcript-bubble.partial {
            opacity: 0.7;
            border-style: dashed;
        }

        .stage-step.active .step-dot {
            background-color: #4f46e5;
            /* brand-600 */
            color: white;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        .stage-step.active .step-label {
            color: #4338ca;
            /* brand-700 */
            font-weight: 700;
        }

        .stage-step.completed .step-dot {
            background-color: #e0e7ff;
            /* brand-100 */
            color: #4f46e5;
            /* brand-600 */
        }

        /* Active Insight Card Flash */
        @keyframes flashBorder {
            0% {
                border-color: rgba(99, 102, 241, 0);
            }

            50% {
                border-color: rgba(99, 102, 241, 1);
            }

            100% {
                border-color: rgba(99, 102, 241, 0);
            }
        }

        .flash-border {
            animation: flashBorder 1s ease-out;
        }
    </style>
</head>

<body class="flex flex-col h-screen text-slate-900 font-sans">

    <!-- Top Bar -->
    <div class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-20 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white font-bold">SF
                </div>
                <h1
                    class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-brand-600 to-purple-600">
                    SalesFlow AI</h1>
            </div>
            <div class="h-6 w-px bg-slate-200 mx-2"></div>
            <span class="text-sm font-medium text-slate-500">Live Monitor</span>
        </div>

        <div class="flex items-center gap-4">
            <!-- Health Check Button -->
            <button id="btn-settings" onclick="openHealthCheck()"
                class="p-2 text-slate-400 hover:text-brand-600 hover:bg-brand-50 rounded-full transition-colors"
                title="×‘×“×™×§×ª ××¢×¨×›×•×ª">
                <i data-lucide="activity" class="w-5 h-5"></i>
            </button>
            <div class="flex items-center gap-3 pl-4 border-l border-slate-200">
                <div
                    class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-medium text-xs">
                    OZ</div>
                <div class="text-sm">
                    <div class="font-bold text-slate-700">×¢×•××¨ ×–× ×•</div>
                    <div class="text-[10px] text-slate-500">Sales Manager</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Workspace -->
    <div class="flex flex-1 overflow-hidden">

        <!-- RIGHT PANEL: Call Status & Controls (Col 1) -->
        <aside class="w-80 flex flex-col border-e border-slate-200 bg-white overflow-y-auto">

            <!-- Dialer Section (Injected into new design) -->
            <div class="p-6 border-b border-slate-100 bg-slate-50/50">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                    <i data-lucide="phone" class="w-3 h-3"></i> ×—×™×™×’×Ÿ
                </h3>

                <div class="space-y-3">
                    <div class="relative">
                        <input type="tel" id="phone-input" placeholder="×”×›× ×¡ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ..."
                            class="w-full pl-3 pr-10 py-2.5 bg-white border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 shadow-sm transition-all text-left"
                            dir="ltr" />
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                            <i data-lucide="keypad" class="w-4 h-4"></i>
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button id="btn-call"
                            class="flex items-center justify-center gap-2 bg-brand-600 hover:bg-brand-700 text-white py-2.5 rounded-xl transition-all shadow-sm shadow-brand-200 font-medium">
                            <i data-lucide="phone-call" class="w-4 h-4"></i>
                            <span>×—×™×™×’</span>
                        </button>
                        <button id="btn-hangup"
                            class="hidden flex items-center justify-center gap-2 bg-rose-500 hover:bg-rose-600 text-white py-2.5 rounded-xl transition-all shadow-sm shadow-rose-200 font-medium">
                            <i data-lucide="phone-off" class="w-4 h-4"></i>
                            <span>× ×ª×§</span>
                        </button>
                    </div>

                    <div id="call-status-text" class="text-xs text-center text-slate-400 h-4">××•×›×Ÿ ×œ×©×™×—×”</div>
                </div>
            </div>

            <!-- Lead Info Header -->
            <div class="p-6 border-b border-slate-100">
                <div class="flex justify-between items-start mb-3">
                    <div
                        class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center text-lg font-bold text-slate-500">
                        M</div>
                    <div
                        class="px-2 py-0.5 rounded text-[10px] font-bold bg-amber-50 text-amber-700 border border-amber-100">
                        WARM</div>
                </div>
                <h2 class="text-base font-bold text-slate-900 mb-1" id="active-contact">××™×›××œ ×¨×•×¡</h2>
                <div class="flex items-center text-sm text-slate-500 mb-3">
                    <i data-lucide="building-2" class="w-3.5 h-3.5 ml-1.5"></i>
                    Acme Corp Ltd.
                </div>
            </div>

            <!-- Stages Stepper -->
            <div class="p-6 flex-1 overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">××”×œ×š ×”×©×™×—×”</h3>
                    <span id="call-timer" class="text-[10px] text-slate-400 font-mono">00:00</span>
                </div>

                <div class="relative space-y-0 text-sm">
                    <!-- Stage Item: Opening -->
                    <div class="stage-step relative flex gap-4 pb-8 group min-h-[3rem]" data-stage="Opening">
                        <div class="absolute right-[9px] top-6 bottom-0 w-px bg-slate-100"></div>
                        <div
                            class="step-dot relative z-10 w-5 h-5 rounded-full bg-white border border-slate-200 text-slate-300 flex items-center justify-center flex-shrink-0 transition-all mt-0.5">
                            <div class="w-1.5 h-1.5 rounded-full bg-current"></div>
                        </div>
                        <div class="flex flex-col pt-0.5">
                            <span
                                class="step-label text-slate-700 font-medium leading-none transition-colors">×¤×ª×™×—×”</span>
                        </div>
                    </div>

                    <!-- Stage Item: Discovery -->
                    <div class="stage-step relative flex gap-4 pb-8 group min-h-[3rem]" data-stage="Discovery">
                        <div class="absolute right-[9px] top-6 bottom-0 w-px bg-slate-100"></div>
                        <div
                            class="step-dot relative z-10 w-5 h-5 rounded-full bg-white border border-slate-200 text-slate-300 flex items-center justify-center flex-shrink-0 transition-all mt-0.5">
                            <div class="w-1.5 h-1.5 rounded-full bg-current"></div>
                        </div>
                        <div class="flex flex-col pt-0.5">
                            <span class="step-label text-slate-700 font-medium leading-none transition-colors">×’×™×œ×•×™
                                ×¦×¨×›×™×</span>
                        </div>
                    </div>

                    <!-- Stage Item: Solution -->
                    <div class="stage-step relative flex gap-4 pb-8 group min-h-[3rem]" data-stage="Solution">
                        <div class="absolute right-[9px] top-6 bottom-0 w-px bg-slate-100"></div>
                        <div
                            class="step-dot relative z-10 w-5 h-5 rounded-full bg-white border border-slate-200 text-slate-300 flex items-center justify-center flex-shrink-0 transition-all mt-0.5">
                            <div class="w-1.5 h-1.5 rounded-full bg-current"></div>
                        </div>
                        <div class="flex flex-col pt-0.5">
                            <span class="step-label text-slate-700 font-medium leading-none transition-colors">×”×¦×’×ª
                                ×¤×ª×¨×•×Ÿ</span>
                        </div>
                    </div>

                    <!-- Stage Item: Objections -->
                    <div class="stage-step relative flex gap-4 pb-8 group min-h-[3rem]" data-stage="Objections">
                        <div class="absolute right-[9px] top-6 bottom-0 w-px bg-slate-100"></div>
                        <div
                            class="step-dot relative z-10 w-5 h-5 rounded-full bg-white border border-slate-200 text-slate-300 flex items-center justify-center flex-shrink-0 transition-all mt-0.5">
                            <div class="w-1.5 h-1.5 rounded-full bg-current"></div>
                        </div>
                        <div class="flex flex-col pt-0.5">
                            <span class="step-label text-slate-700 font-medium leading-none transition-colors">×˜×™×¤×•×œ
                                ×‘×”×ª× ×’×“×•×™×•×ª</span>
                        </div>
                    </div>

                    <!-- Stage Item: Closing -->
                    <div class="stage-step relative flex gap-4 group min-h-[3rem]" data-stage="Closing">
                        <div
                            class="step-dot relative z-10 w-5 h-5 rounded-full bg-white border border-slate-200 text-slate-300 flex items-center justify-center flex-shrink-0 transition-all mt-0.5">
                            <div class="w-1.5 h-1.5 rounded-full bg-current"></div>
                        </div>
                        <div class="flex flex-col pt-0.5">
                            <span
                                class="step-label text-slate-700 font-medium leading-none transition-colors">×¡×’×™×¨×”</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metrics Footer -->
            <div class="p-6 border-t border-slate-100 bg-slate-50/50 space-y-5">
                <!-- Score -->
                <div>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs font-semibold text-slate-500">×¦×™×•×Ÿ ××™×›×•×ª ×©×™×—×”</span>
                        <div class="flex items-center gap-1">
                            <span id="score-val" class="text-sm font-bold text-slate-900">0</span>
                            <span class="text-[10px] text-slate-400">/ 100</span>
                        </div>
                    </div>
                    <div class="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                        <div id="score-bar" class="h-full bg-emerald-500 rounded-full transition-all duration-1000"
                            style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CENTER PANEL: Chat & Active Call (Col 2) -->
        <main class="flex-1 flex flex-col items-stretch relative min-w-0 bg-white">

            <!-- Transcript Feed -->
            <div id="transcript-scroll" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4 scroll-smooth">
                <!-- Messages will be injected here -->
                <div class="text-center py-10 text-slate-300 text-sm">
                    ×”×©×™×—×” ×ª×•×¤×™×¢ ×›××Ÿ...
                </div>
            </div>

            <!-- Manual Input Area -->
            <div class="border-t border-slate-200 p-4 bg-slate-50 z-10">
                <div class="relative max-w-3xl mx-auto w-full">
                    <input type="text" id="note-input" placeholder="×”×•×¡×£ ×”×¢×¨×” ××™×©×™×ª..."
                        class="w-full pl-12 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 outline-none transition-all shadow-sm" />
                    <button
                        class="absolute left-1.5 top-1/2 -translate-y-1/2 p-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors shadow-sm">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </main>

        <!-- LEFT PANEL: Insights (Col 3) -->
        <aside class="w-80 flex flex-col border-s border-slate-200 bg-slate-50 hidden xl:flex">
            <div class="p-5 border-b border-slate-200 bg-white sticky top-0 z-10">
                <h2 class="text-base font-bold text-slate-900 flex items-center gap-2">
                    <i data-lucide="zap" class="w-4 h-4 text-brand-600"></i>
                    ××¨×›×– ×‘×™× ×”
                </h2>
            </div>

            <div class="p-5 space-y-6 flex-1 overflow-y-auto">

                <!-- AI Insight Card -->
                <div id="ai-insight-card"
                    class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden transition-all duration-300">
                    <div
                        class="px-4 py-3 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white flex justify-between items-center">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                            <i data-lucide="sparkles" class="w-3 h-3 text-brand-500"></i>
                            ×˜×™×¤ ×—×›×
                        </h3>
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                    </div>

                    <div class="p-4 space-y-3">
                        <div id="insight-text" class="text-sm font-bold text-slate-800 leading-snug">
                            ×××ª×™×Ÿ ×œ×ª×•×‘× ×•×ª ×¨××©×•× ×™×•×ª...
                        </div>

                        <div id="insight-suggestion"
                            class="hidden text-xs text-slate-600 bg-brand-50 p-2.5 rounded-lg border border-brand-100 italic">
                            "××©×¤×˜ ××•××œ×¥ ×™×•×¤×™×¢ ×›××Ÿ"
                        </div>
                    </div>
                </div>

                <!-- Helper Actions -->
                <div>
                    <div class="flex items-center justify-between mb-3 px-1">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                            <i data-lucide="check-square" class="w-3.5 h-3.5"></i> ×¨×©×™××ª ×‘×“×™×§×”
                        </h3>
                    </div>

                    <div class="space-y-2">
                        <div
                            class="flex items-center gap-2 p-2 bg-white rounded-lg border border-slate-200 text-xs text-slate-600">
                            <i data-lucide="circle" class="w-3 h-3 text-slate-300"></i> ×‘× ×™×™×ª ×›×™××™×” ×¨××©×•× ×™×ª
                        </div>
                        <div
                            class="flex items-center gap-2 p-2 bg-white rounded-lg border border-slate-200 text-xs text-slate-600">
                            <i data-lucide="circle" class="w-3 h-3 text-slate-300"></i> ×–×™×”×•×™ ×ª×§×¦×™×‘ ×œ×§×•×—
                        </div>
                        <div
                            class="flex items-center gap-2 p-2 bg-white rounded-lg border border-slate-200 text-xs text-slate-600">
                            <i data-lucide="circle" class="w-3 h-3 text-slate-300"></i> ×”×¦×’×ª ×™×ª×¨×•× ×•×ª ×”××•×¦×¨
                        </div>
                    </div>
                </div>

            </div>
        </aside>

    </div>

    <!-- Health Check Modal -->
    <div id="health-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <div
            class="bg-white rounded-2xl w-96 shadow-2xl border border-slate-200 overflow-hidden transform transition-all scale-100 p-0">
            <div class="flex justify-between items-center p-4 border-b border-slate-100 bg-slate-50">
                <h3 class="font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="activity" class="w-4 h-4 text-brand-600"></i> ×‘×“×™×§×ª ××¢×¨×›×•×ª
                </h3>
                <button onclick="closeHealthCheck()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="health-content" class="p-6">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- LIBRARIES -->
    <script src="https://sdk.twilio.com/js/client/v1.14/twilio.min.js"></script>

    <!-- INITIALIZE LUCIDE -->
    <script>
        lucide.createIcons();
    </script>

    <!-- APPLICATION LOGIC -->
    <script>
        // --- GLOBAL VARIABLES ---
        let device;
        let activeCall = null;
        let isCallActive = false;
        let ws;
        let callStartTime;
        let timerInterval;

        // --- DOM ELEMENTS logic mapping ---
        const btnCall = document.getElementById('btn-call');
        const btnHangup = document.getElementById('btn-hangup');
        const phoneInput = document.getElementById('phone-input');
        const statusText = document.getElementById('call-status-text');
        const feed = document.getElementById('transcript-scroll');
        const timerEl = document.getElementById('call-timer');

        // --- TWILIO SETUP ---
        async function initTwilio() {
            try {
                const response = await fetch('/token');
                const data = await response.json();

                device = new Twilio.Device(data.token, {
                    codecPreferences: ['opus', 'pcmu'],
                    fakeLocalDTMF: true,
                    enableRingingState: true
                });

                device.on('ready', () => updateStatus('××•×›×Ÿ ×œ×©×™×—×”', 'ready'));
                device.on('error', (error) => {
                    console.error('Twilio Error:', error);
                    updateStatus('×©×’×™××”: ' + error.message, 'error');
                });

                device.on('connect', (conn) => {
                    activeCall = conn;
                    isCallActive = true;
                    startTimer();
                    updateStatus('×‘×©×™×—×”', 'active');
                    toggleButtons(true);

                    // Setup WebSocket for transcript
                    setupWebSocket(conn.parameters.CallSid);
                });

                device.on('disconnect', () => {
                    activeCall = null;
                    isCallActive = false;
                    stopTimer();
                    updateStatus('×©×™×—×” ×”×¡×ª×™×™××”', 'ready');
                    toggleButtons(false);

                    // Trigger Summary
                    window.location.href = '/summary.html';
                });

            } catch (err) {
                console.error('Token Error:', err);
                updateStatus('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª', 'error');
            }
        }

        function updateStatus(text, type) {
            statusText.textContent = text;
            statusText.className = 'text-xs text-center h-4 ' +
                (type === 'error' ? 'text-red-500' :
                    type === 'active' ? 'text-emerald-500 font-bold' :
                        'text-slate-400');
        }

        function toggleButtons(isActive) {
            if (isActive) {
                btnCall.classList.add('hidden');
                btnHangup.classList.remove('hidden');
            } else {
                btnCall.classList.remove('hidden');
                btnHangup.classList.add('hidden');
            }
        }

        // --- TIMER ---
        function startTimer() {
            callStartTime = Date.now();
            timerInterval = setInterval(() => {
                const delta = Math.floor((Date.now() - callStartTime) / 1000);
                const m = Math.floor(delta / 60).toString().padStart(2, '0');
                const s = (delta % 60).toString().padStart(2, '0');
                timerEl.textContent = `${m}:${s}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerEl.textContent = '00:00';
        }

        // --- WEBSOCKET ---
        function setupWebSocket(callSid) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/client-socket`);

            ws.onopen = () => {
                console.log('WS Connected');
                ws.send(JSON.stringify({ type: 'register', callSid: callSid }));
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);

                if (msg.type === 'transcript') {
                    addTranscriptItem({
                        role: msg.role,
                        text: msg.text,
                        isFinal: msg.isFinal
                    });
                } else if (msg.type === 'coaching') {
                    updateInsight(msg.data);
                } else if (msg.type === 'call_summary') {
                    sessionStorage.setItem('lastCallSummary', JSON.stringify(msg.data));
                }
            };
        }

        // --- ACTIONS ---
        btnCall.addEventListener('click', () => {
            const number = phoneInput.value;
            if (!number) return alert('× × ×œ×”×–× ×™ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ');

            updateStatus('××—×™×™×’...', 'ready');
            device.connect({ To: number });
        });

        btnHangup.addEventListener('click', () => {
            if (activeCall) activeCall.disconnect();
        });

        // --- UI UPDATERS ---
        function addTranscriptItem(data) {
            const role = data.role; // 'agent' | 'customer' | 'note'
            let text = data.text || '';
            const isFinal = data.isFinal !== false;

            // Cleanup 
            text = text.replace(/<end>/gi, '').trim();
            if (!text) return;

            // Check for existing partial bubble to update
            const lastItem = feed.lastElementChild;
            const lastWasPartial = lastItem && lastItem.dataset.partial === 'true';
            const lastWasSameSpeaker = lastItem && lastItem.dataset.speaker === role;

            if (lastWasPartial && lastWasSameSpeaker) {
                // UPDATE existing bubble
                const bubble = lastItem.querySelector('.transcript-bubble');
                if (bubble) bubble.innerText = text;

                if (isFinal) {
                    lastItem.dataset.partial = 'false';
                    if (bubble) bubble.classList.remove('partial');
                }

                scrollTranscriptToBottom();
                return;
            }

            // CREATE new bubble
            const messageEl = document.createElement('div');
            // Add specific classes
            messageEl.className = 'transcript-message';
            messageEl.classList.add(role); // 'agent' or 'customer'

            messageEl.dataset.speaker = role;
            messageEl.dataset.partial = (!isFinal).toString();

            // Bubble
            const bubbleEl = document.createElement('div');
            bubbleEl.classList.add('transcript-bubble');
            if (!isFinal) bubbleEl.classList.add('partial');
            bubbleEl.innerText = text;

            messageEl.appendChild(bubbleEl);
            feed.appendChild(messageEl);
            scrollTranscriptToBottom();
        }

        function scrollTranscriptToBottom() {
            feed.scrollTop = feed.scrollHeight;
        }

        function updateInsight(data) {
            // 1. Update Score (Linear Bar)
            if (typeof data.score === 'number') {
                const scoreVal = document.getElementById('score-val');
                const scoreBar = document.getElementById('score-bar');

                scoreVal.innerText = data.score;
                scoreBar.style.width = data.score + '%';

                // Color grading
                scoreBar.className = 'h-full rounded-full transition-all duration-1000 ' +
                    (data.score > 80 ? 'bg-emerald-500' :
                        data.score < 50 ? 'bg-rose-500' : 'bg-amber-500');
            }

            // 2. Update Stage (Vertical Stepper classes)
            if (data.stage) {
                const stages = document.querySelectorAll('.stage-step');
                let foundCurrent = false;

                stages.forEach(step => {
                    const stageName = step.dataset.stage; // Opening, Discovery...

                    // Simple logic: If found current stage, mark it active. Previous are completed.
                    // Note: This assumes data.stage is an ARRAY of stages or a single string. 
                    // Let's assume data.stage might include "Discovery"

                    if (data.stage.includes(stageName)) {
                        // ACTIVE
                        step.classList.add('active');
                        step.classList.remove('completed');
                        foundCurrent = true;
                    } else if (!foundCurrent) {
                        // COMPLETED
                        step.classList.add('completed');
                        step.classList.remove('active');
                    } else {
                        // FUTURE
                        step.classList.remove('active', 'completed');
                    }
                });
            }

            // 3. Insight & Suggestion
            const card = document.getElementById('ai-insight-card');
            const textEl = document.getElementById('insight-text');
            const suggestEl = document.getElementById('insight-suggestion');

            // Flash effect
            card.classList.add('flash-border');
            setTimeout(() => card.classList.remove('flash-border'), 1000);

            // Message is the short analysis
            if (data.message) {
                textEl.innerText = data.message;
            }

            // Suggested Reply
            if (data.suggested_reply) {
                suggestEl.innerText = `"${data.suggested_reply}"`;
                suggestEl.classList.remove('hidden');
            } else {
                suggestEl.classList.add('hidden');
            }
        }

        // --- HEALTH CHECK ---
        async function openHealthCheck() {
            const modal = document.getElementById('health-modal');
            const content = document.getElementById('health-content');

            modal.classList.remove('hidden');
            content.innerHTML = `<div class="text-center py-8 text-slate-400">
                <div class="animate-spin text-2xl mb-2">â³</div>
                ×‘×•×“×§ ××¢×¨×›×•×ª...
            </div>`;

            try {
                const res = await fetch('/api/health');
                const data = await res.json();

                const statusIcon = (status) => {
                    if (status === 'ok') return 'ğŸŸ¢';
                    if (status === 'error') return 'ğŸ”´';
                    if (status === 'not_configured') return 'ğŸŸ¡';
                    return 'âšª';
                };

                content.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${statusIcon(data.server.status)}</span>
                                <span class="font-bold text-slate-700">Server</span>
                            </div>
                            <span class="text-xs text-slate-500 font-mono">Uptime: ${data.server.uptime}s</span>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${statusIcon(data.twilio.status)}</span>
                                <span class="font-bold text-slate-700">Twilio</span>
                            </div>
                            <span class="text-xs text-slate-500">${data.twilio.message || statusIcon(data.twilio.status)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${statusIcon(data.soniox.status)}</span>
                                <span class="font-bold text-slate-700">Soniox</span>
                            </div>
                            <span class="text-xs text-slate-500">${data.soniox.message || statusIcon(data.soniox.status)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${statusIcon(data.openai.status)}</span>
                                <span class="font-bold text-slate-700">OpenAI</span>
                            </div>
                            <span class="text-xs text-slate-500">${data.openai.message || statusIcon(data.openai.status)}</span>
                        </div>
                    </div>
                `;
            } catch (e) {
                content.innerHTML = `<div class="text-center py-8 text-red-500">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</div>`;
            }
        }

        function closeHealthCheck() {
            document.getElementById('health-modal').classList.add('hidden');
        }

        // --- DEV SHORTCUTS & INIT ---
        document.addEventListener('keydown', (e) => {
            if (e.shiftKey && e.key === 'S') {
                // Simulate Call
                addTranscriptItem({ role: 'agent', text: '×‘×“×™×§×ª ××¢×¨×›×ª... ×©×œ×•×!' });
                setTimeout(() => addTranscriptItem({ role: 'customer', text: '××”×œ×Ÿ, ×× ×™ ×¨×•×¦×” ×œ×§× ×•×ª.' }), 1500);
                setTimeout(() => updateInsight({ score: 85, stage: ['Discovery'], message: '×–×™×”×•×™ ×”×–×“×× ×•×ª ××›×™×¨×”.', suggested_reply: '××¢×•×œ×”, ×‘×•× × ×‘×“×•×§ ××” ××ª××™× ×œ×š.' }), 2500);
            }
        });

        // Start
        initTwilio();
    </script>
</body>

</html>